#!/bin/sh config_no_run
# v001 2012-03-25 nodeJS # v002 2012-03-26 mongodb

#### app config ####

# strict "JSON" config for multiple gsm modules device
# MTS-like or Velcom-like numbers are being assigned to each module
GSM_ADDR='localhost'

# MV's GSM is Cinterion's clone of Siemens' BG2-W. Thus see "_cmdle" setup.

# (XT55 Siemens Mobile doc) The "AT" or "at" prefix must be set at
# the beginning of each command line.
# To terminate a command line enter <CR>
#,"module2": { "own":"set me in cfg", "numre": "+37529[2578] +37533" }
#8223: ,"module1": { "own":"+375296100356", "numre": "+37529[136]  +37544" }
#8123:
#,"module1": { "own":"+375291348778", "numre": "+37529[136]  +37544" }
#,"module2": { "own":"+375297667089", "numre": "+37529[136]  +37544" }
#,"module2": { "own":"+375293774507", "numre": "+37529[136]  +37544" }
#,"module1": { "own":"+375297648526", "numre": "+37529[136]  +37544" }
#cinterion: ,"_atsetup": "ate1v1+CMEE=2;^SM20=1,0" -- module hungs up on outcoming voice calls
#simcom: ,"_atsetup": "ate1v1+CMEE=2"

#NOTE: JSON.parse() doen't do REs, so it must be implemented in conf load
#,"_sms_schedule": { "startTime":0 ,"deltaSec":60 ,"endTime":0 ,"countSMS":4 }

# if CMS ERROR 500 (no money), timeout 48192ms can catch this message
# defaults:
# "_smsIncomeCheckTimeSec": 16*1024 ms
# "_smsQueueCheckTimeSec": 1024 ms
# "_smsAutoRun": 1 || 0

# DB must be the same for all modules
DB_PREFIX="HU001"

# "BG2-W" in name switches internal logic
gsm_model_BG2(){ #+375298077782 | +37529[136]  +37544 | module1
echo '{ "name": "'$DB_PREFIX': PORtech Cinterion BG2-W"
,"'$3'": { "own":"'$1'", "numre": "'$2'" }
,"_other_options": "must be with underscore prefix"
,"_atsetup": "ate1v1+CMEE=2"
,"_cmdle": "\r"
,"_csms": "yes"
,"_sms_schedule": {
 "startTime":"16:00" ,"endTime":"18:00"
,"deltaOneMsgSec":7 , "sendSMSCount":2
}
,"_smsIncomeCheckTimeSec": 55
,"_timeoutLogin": 8192
,"_timeoutGet": 8192
,"_timeoutAtSync": 8192
,"_timeoutUSSD": 8192
,"_timeoutSendSMS": 18192
}'
} # telnet + BG2
#,"_time": 1

# "E220" in name switches internal logic
gsm_model_huawei(){ #+375298077782 | +37529[136]  +37544
echo '{ "name": "'$DB_PREFIX': HUAWEI E220 HSDPA USB modem"
,"one": { "own":"'$1'", "numre": "'$2'" }
,"_csms": "yes"
,"_sms_schedule": {
 "startTime":"16:00" ,"endTime":"18:00"
,"deltaOneMsgSec":7 , "sendSMSCount":128
}
,"_smsIncomeCheckTimeSec": 55
,"_smsQueueCheckTimeSec": 2
,"_timeoutSendSMS": 48192
,"_timeoutAtSync": 8192
}'
} # gsm_model

# one DB for all modules and devices
# number of setup items must match number of NODEJS_APPs
# first NODEJS_APP is master, all slaves get no $env.NODEJS_APP

: <<"!"

{
	"addr": "'$GSM_ADDR:8023'"
	,"model": '`gsm_model_BG2 "+375445447466" "" "module1"`'
}

,{
	"addr": "'$GSM_ADDR:8123'"
	,"model": '`gsm_model_BG2 "+375297382222"  "+37529[2578]  +37533" "module2"`'
}

{
	"addr": "COM14"
	,"model": '`gsm_model_huawei "+375298077782"`'
}
!

GSM_SETUP='[
{
	"addr": "COM3"
	,"model": '`gsm_model_huawei "+375298077782"`'
}
]'

#### brain setup ####
# can be a [:blank:] separated set of services which are one app
NODEJS_APP='_app/telsms.js:3002.3003 _app/telsms.js:0.3004'
NODEJS_APP_NAME='SMS send/recv system'

# get it into node's process.env
export GSM_SETUP

#### memory setup ####
# NOTE: default mongodb port is used. admin port = $((this+1000)) i.e 28017
MONGOD_SRVs='127.0.0.1:27016/_data/db'

JSAPPLOGS='logs/'

cygwin() {
NODE_PATH='..\nodenwer\lib\node_modules'
NODEJS='node.exe' # can be other version
MONGOD='mongod.exe --quiet --rest' # --journal
MONGO='mongo.exe'
}

linux_gnu() {
NODE_PATH='/usr/local/lib/node_modules'
NODEJS='node'
MONGOD='mongod --quiet --rest' # --journal
MONGO='mongo'
}
[ 'cygwin' = "$OSTYPE" ] && cygwin || linux_gnu
export NODE_PATH

#GSM_ADDR='localhost:23'
#GSM_MODEL='{ "name": "ERICSSON_R520M Mobile Phone NO SMS TEXT MODE"
#,"_sms_setup": "at+cmgf=1;+cnmi=3,1,0,0,0"
#}'
#GSM_ADDR='COM14'
#GSM_MODEL='{ "name": "ZTE_MF637 USB MODEM SHIT"
#,"_cmdle": "\n"
#}'
#,"_sms_setup": "at+cmgf=1;+cnmi=2,1,0,2,1"
